---
import "../styles/global.css";
import SEOHead from "../components/SEOHead.astro";

interface Props {
  title?: string;
  description?: string;
  canonical?: string;
  image?: string;
  type?: 'website' | 'article' | 'business.business';
  structuredData?: Record<string, any>;
  noindex?: boolean;
}

const { 
  title = 'Gaming Venues Directory', 
  description = 'Discover the best gambling establishments and gaming venues',
  canonical,
  image,
  type = 'website',
  structuredData,
  noindex = false
} = Astro.props;
---

<!doctype html>
<html lang="en" data-theme="light">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="generator" content={Astro.generator} />
		
		<!-- Performance optimizations -->
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link rel="dns-prefetch" href="//images.unsplash.com" />
		
		<!-- Theme color for mobile browsers -->
		<meta name="theme-color" content="#3b82f6" />
		<meta name="msapplication-TileColor" content="#3b82f6" />
		
		<!-- Apple touch icon -->
		<link rel="apple-touch-icon" href="/favicon.svg" />
		
		<!-- Manifest for PWA -->
		<link rel="manifest" href="/manifest.json" />
		
		<!-- SEO Meta Tags -->
		<SEOHead 
			title={title}
			description={description}
			canonical={canonical}
			image={image}
			type={type}
			structuredData={structuredData}
			noindex={noindex}
		/>
		
		<!-- Allow pages to override head content -->
		<slot name="head" />
	</head>
	<body class="min-h-screen bg-base-200 antialiased">
		<!-- Skip to main content for accessibility -->
		<a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-primary text-primary-content px-4 py-2 rounded-md z-50">
			Skip to main content
		</a>
		
		<!-- Main content wrapper -->
		<div id="main-content" class="min-h-screen flex flex-col">
			<slot />
		</div>
		
		<!-- Global error handler -->
		<script>
			// Service worker registration for caching
			if ('serviceWorker' in navigator) {
				window.addEventListener('load', function() {
					navigator.serviceWorker.register('/sw.js').then(function(registration) {
						console.log('SW registered: ', registration);
					}).catch(function(registrationError) {
						console.log('SW registration failed: ', registrationError);
					});
				});
			}
			
			// Global performance monitoring
			window.addEventListener('load', function() {
				// Log performance metrics
				if ('performance' in window) {
					const perfData = performance.getEntriesByType('navigation')[0] as PerformanceNavigationTiming;
					if (perfData) {
						console.log('Page load time:', perfData.loadEventEnd - perfData.loadEventStart, 'ms');
					}
				}
			});
			
			// Enhanced image lazy loading fallback
			document.addEventListener('DOMContentLoaded', function() {
				// Fallback for browsers without native lazy loading
				if (!('loading' in HTMLImageElement.prototype)) {
					const script = document.createElement('script');
					script.src = 'https://polyfill.io/v3/polyfill.min.js?features=IntersectionObserver';
					document.head.appendChild(script);
				}
				
				// Handle image loading errors globally
				document.addEventListener('error', function(e) {
					if (e.target && (e.target as HTMLElement).tagName === 'IMG') {
						const img = e.target as HTMLImageElement;
						if (img.dataset.fallback && img.src !== img.dataset.fallback) {
							console.warn('Image failed to load:', img.src, 'Using fallback:', img.dataset.fallback);
							img.src = img.dataset.fallback;
							img.classList.add('fallback-image');
							// Remove srcset to prevent further errors
							img.removeAttribute('srcset');
						}
					}
				}, true);
			});
		</script>
	</body>
</html>

<style>
	html,
	body {
		margin: 0;
		width: 100%;
		min-height: 100%;
		font-feature-settings: 'kern' 1, 'liga' 1, 'calt' 1;
		text-rendering: optimizeLegibility;
		-webkit-font-smoothing: antialiased;
		-moz-osx-font-smoothing: grayscale;
	}
	
	/* Improved focus styles */
	:focus-visible {
		outline: 2px solid hsl(var(--p));
		outline-offset: 2px;
		border-radius: 0.25rem;
	}
	
	/* Better scrollbar styling */
	::-webkit-scrollbar {
		width: 8px;
		height: 8px;
	}
	
	::-webkit-scrollbar-track {
		background: hsl(var(--b2));
	}
	
	/* Global image consistency rules */
	.card figure {
		margin: 0;
		padding: 0;
	}
	
	.card figure.aspect-card {
		aspect-ratio: 3 / 2;
		min-height: 200px;
		background-color: #f3f4f6;
	}
	
	/* Ensure all business card images have consistent sizing */
	.card .image-container {
		width: 100%;
		height: 100%;
	}
	
	.card .image-container.aspect-card {
		aspect-ratio: 3 / 2;
		min-height: 200px;
	}
	
	.card .optimized-image {
		width: 100% !important;
		height: 100% !important;
		object-fit: cover !important;
		object-position: center !important;
	}
	
	::-webkit-scrollbar-thumb {
		background: hsl(var(--bc) / 0.3);
		border-radius: 4px;
	}
	
	::-webkit-scrollbar-thumb:hover {
		background: hsl(var(--bc) / 0.5);
	}
	
	/* Selection styling */
	::selection {
		background: hsl(var(--p) / 0.3);
		color: hsl(var(--pc));
	}
	
	/* Smooth scrolling for supported browsers */
	@supports (scroll-behavior: smooth) {
		html {
			scroll-behavior: smooth;
		}
	}
	
	/* High contrast mode adjustments */
	@media (prefers-contrast: high) {
		body {
			background: white;
			color: black;
		}
	}
	
	/* Dark mode adjustments */
	@media (prefers-color-scheme: dark) {
		html[data-theme="light"] {
			color-scheme: light;
		}
	}
	
	/* Print styles */
	@media print {
		body {
			background: white !important;
			color: black !important;
		}
		
		.no-print {
			display: none !important;
		}
	}
</style>
